<% layout('/layouts/boilerplate') -%>

<script>
  const listing = <%- JSON.stringify(listing) %>;
  const isDefaultLocation = <%- JSON.stringify(isDefaultLocation) %>;
  
  // ‚≠ê Pass LocationIQ API key to frontend for map tiles
  window.LOCATIONIQ_API_KEY = '<%= process.env.LOCATIONIQ_API_KEY %>';
</script>

<main style="max-width:900px;margin:2rem auto;padding:1rem;font-family:Inter,sans-serif;">

  <!-- Title -->
  <h1 style="margin-top:1.2rem;font-size:2rem;font-weight:700;">
    <%= listing.title %>
  </h1>

  <!-- Image with better error handling -->
  <div style="border-radius:12px;overflow:hidden;width:300px;height:200px;box-shadow:0 4px 18px rgba(0,0,0,0.12);">
    <% 
      // Default fallback image from your Cloudinary
      const DEFAULT_IMAGE_URL = 'https://res.cloudinary.com/dgu8te3bn/image/upload/v1771003245/Homekuti_DEV/kzjbrisg2uqssvvp99a3.jpg';
      
      // Determine the image URL to display
      let imageUrl = DEFAULT_IMAGE_URL;
      
      if (listing.image) {
        if (typeof listing.image === 'string') {
          imageUrl = listing.image; // Old format: direct URL string
        } else if (listing.image.url) {
          imageUrl = listing.image.url; // New format: object with url property
        }
      }
    %>
    <img src="<%= imageUrl %>" 
         alt="<%= listing.title %>"
         style="width:100%;height:100%;object-fit:cover;"
         onerror="this.src='<%= DEFAULT_IMAGE_URL %>';">
  </div>

  <!-- Owner -->
  <p><i>Owned by <%= listing.owner.username || "Admin" %></i></p>

  <!-- Description -->
  <p style="margin-top:1rem;line-height:1.6;color:#444;">
    <strong>Description:</strong>
    <%= listing.description || "No description provided." %>
  </p>

  <!-- Location -->
  <p style="margin-top:1rem;color:#444;">
    <strong>Location:</strong>
    <%= listing.location %>, <%= listing.country %>
  </p>

  <!-- Price -->
  <p style="font-size:1.2rem;margin:0.4rem 0;">
    <strong>Price:</strong> ‚Çπ<%= listing.price %> / night
  </p>

  <!-- Edit/Delete -->
  <% if(currUser && currUser._id.equals(listing.owner._id)) { %>
    <div class="edit-delete-btn">
      <form method="GET" action="/listings/<%= listing._id %>/edit" class="form-no-card">
        <button type="submit" class="hk-btn me-2">Edit</button>
      </form>

      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE"
        onsubmit="return confirm('Delete this listing? This will also remove the image from storage.');"
        class="form-no-card">
        <button type="submit" class="hk-btn">Delete</button>
      </form>
    </div>
  <% } %>

  <hr style="margin:1rem 0;">

  <!-- REVIEW FORM -->
  <% if(currUser){ %>

    <h4 class="mb-3">Leave a Review</h4>

    <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">

      <div class="mb-3">
        <fieldset class="starability-coinFlip">
          <legend class="form-label">Rating (1‚Äì5)</legend>

          <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked>

          <input type="radio" id="first-rate1" name="review[rating]" value="1">
          <label for="first-rate1">1 star</label>

          <input type="radio" id="first-rate2" name="review[rating]" value="2">
          <label for="first-rate2">2 stars</label>

          <input type="radio" id="first-rate3" name="review[rating]" value="3">
          <label for="first-rate3">3 stars</label>

          <input type="radio" id="first-rate4" name="review[rating]" value="4">
          <label for="first-rate4">4 stars</label>

          <input type="radio" id="first-rate5" name="review[rating]" value="5">
          <label for="first-rate5">5 stars</label>
        </fieldset>
      </div>

      <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea name="review[comment]" id="comment" rows="4" class="form-control" required></textarea>
        <div class="invalid-feedback">Please enter a comment.</div>
      </div>

      <button type="submit" class="hk-btn">Submit Review</button>
    </form>

  <% } else { %>
    <p><a href="/user/signin">Log in</a> to leave a review.</p>
  <% } %>

  <hr style="margin:1.5rem 0;">

  <!-- REVIEWS -->
  <h4 class="mb-3">Reviews: <%= listing.reviews.length %></h4>

  <% if (listing.reviews.length === 0) { %>
    <p style="color:#777;font-style:italic;">
      No reviews yet. Be the first to review.
    </p>
  <% } else { %>
    <div class="row">
      <% for (let review of listing.reviews) { %>
        <div class="card col-md-5 ms-3 mb-3">
          <div class="card-body">
            <h5 class="card-title"><%= review.author.username %></h5>

            <p class="starability-result card-text" data-rating="<%= review.rating %>">
              Rated: <%= review.rating %> stars
            </p>

            <p class="card-text mb-1"><%= review.comment %></p>

            <% if(currUser && currUser._id.equals(review.author._id)){ %>
              <form method="POST"
                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                class="form-no-card mt-2">
                <button type="submit" class="hk-btn" style="width:fit-content">
                  Delete
                </button>
              </form>
            <% } %>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>

  <!-- MAP -->
  <div class="mb-3">
    <h4 class="mb-1">Where you'll be</h4>

    <% if(isDefaultLocation){ %>
      <p style="font-size:0.85rem;color:#888;margin:0;">
        üìç Approximate location shown ‚Äî exact address available after booking.
      </p>
    <% } %>

    <div id="map" style="height:400px; border-radius:12px; border: 1.5px solid black;"></div>
  </div>

</main>

<script src="/js/map.js"></script>
